<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruthLens Quantum</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js for visualizations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .score-ring { stroke-dasharray: 314; stroke-dashoffset: 314; transition: stroke-dashoffset 1s ease-out; }
        .tab-active { background-color: #3B82F6; color: white; }
        .node { stroke: #fff; stroke-width: 1.5px; }
        .link { stroke: #999; stroke-opacity: 0.6; }
        .tooltip { position: absolute; text-align: center; width: auto; height: auto; padding: 8px; font: 12px sans-serif; background: #2d3748; border: 0px; border-radius: 8px; pointer-events: none; color: white; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="w-full max-w-4xl mx-auto p-6 md:p-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-teal-300">TruthLens Quantum</h1>
            <p class="text-gray-400 mt-2">Your AI Co-Pilot for the Truth</p>
        </div>

        <!-- Main Tabs -->
        <div class="flex border-b border-gray-700 mb-6">
            <button id="main-tab-analyzer" class="py-2 px-6 font-semibold rounded-t-md tab-active">Analyzer</button>
            <button id="main-tab-dashboard" class="py-2 px-6 font-semibold text-gray-400 rounded-t-md">Dashboard</button>
        </div>

        <!-- Analyzer Panel -->
        <div id="panel-analyzer">
            <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 shadow-2xl">
                <!-- Input Tabs -->
                <div class="flex border-b border-gray-600 mb-4">
                    <button id="tab-text" class="py-2 px-4 font-semibold rounded-t-md tab-active">Analyze Text</button>
                    <button id="tab-image" class="py-2 px-4 font-semibold text-gray-400 rounded-t-md">Analyze Image</button>
                </div>
                <div id="panel-text">
                    <label for="text-input" class="block text-sm font-medium text-gray-300 mb-2">Enter text or article content:</label>
                    <textarea id="text-input" rows="8" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="Paste content here..."></textarea>
                </div>
                <div id="panel-image" class="hidden">
                     <label for="image-url-input" class="block text-sm font-medium text-gray-300 mb-2">Enter image URL:</label>
                    <input type="url" id="image-url-input" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="https://example.com/image.png">
                </div>
                <button id="analyze-button" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 ease-in-out flex items-center justify-center">
                    <svg id="button-icon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <span id="button-text">Analyze</span>
                </button>
            </div>
            <div id="results-container" class="mt-8 bg-gray-800 border border-gray-700 rounded-lg p-6 shadow-2xl hidden"></div>
            <div id="feed-container" class="mt-8">
                <h2 class="text-2xl font-bold text-center mb-6">Recent Analyses</h2>
                <div id="feed-list" class="space-y-4"></div>
            </div>
        </div>

        <!-- Dashboard Panel -->
        <div id="panel-dashboard" class="hidden">
            <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 shadow-2xl">
                <h3 class="text-xl font-bold mb-4">Misinformation Hot Topics</h3>
                <div id="heatmap-container" class="w-full h-64 bg-gray-900 rounded-md"></div>
                <h3 class="text-xl font-bold mt-8 mb-4">Source Propagation Graph</h3>
                <div id="graph-container" class="w-full h-96 bg-gray-900 rounded-md relative"></div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM References ---
        const elementIds = ['analyze-button', 'button-text', 'button-icon', 'text-input', 'image-url-input', 'results-container', 'feed-list', 'tab-text', 'tab-image', 'panel-text', 'panel-image', 'main-tab-analyzer', 'main-tab-dashboard', 'panel-analyzer', 'panel-dashboard', 'heatmap-container', 'graph-container'];
        const elements = Object.fromEntries(
            elementIds.map(id => {
                const camelCaseId = id.replace(/-(\w)/g, (_, letter) => letter.toUpperCase());
                return [camelCaseId, document.getElementById(id)];
            })
        );
        const { analyzeButton, buttonText, buttonIcon, textInput, imageUrlInput, resultsContainer, feedList, tabText, tabImage, panelText, panelImage, mainTabAnalyzer, mainTabDashboard, panelAnalyzer, panelDashboard, heatmapContainer, graphContainer } = elements;

        // IMPORTANT: Replace this with your live backend URL after deploying it.
        const BASE_URL = 'https://truthlens-backend-rwif.onrender.com';
        let currentMode = 'text';

        // --- Tab Switching ---
        mainTabAnalyzer.addEventListener('click', () => switchMainTab('analyzer'));
        mainTabDashboard.addEventListener('click', () => switchMainTab('dashboard'));
        tabText.addEventListener('click', () => switchInputTab('text'));
        tabImage.addEventListener('click', () => switchInputTab('image'));

        function switchMainTab(tab) {
            const isAnalyzer = tab === 'analyzer';
            mainTabAnalyzer.classList.toggle('tab-active', isAnalyzer);
            mainTabAnalyzer.classList.toggle('text-gray-400', !isAnalyzer);
            mainTabDashboard.classList.toggle('tab-active', !isAnalyzer);
            mainTabDashboard.classList.toggle('text-gray-400', isAnalyzer);
            panelAnalyzer.classList.toggle('hidden', !isAnalyzer);
            panelDashboard.classList.toggle('hidden', isAnalyzer);
            if (!isAnalyzer) loadDashboardData();
        }

        function switchInputTab(mode) {
            currentMode = mode;
            tabText.classList.toggle('tab-active', mode === 'text');
            tabText.classList.toggle('text-gray-400', mode !== 'text');
            tabImage.classList.toggle('tab-active', mode === 'image');
            tabImage.classList.toggle('text-gray-400', mode !== 'image');
            panelText.classList.toggle('hidden', mode !== 'text');
            panelImage.classList.toggle('hidden', mode === 'text');
        }

        // --- Analysis Logic ---
        analyzeButton.addEventListener('click', async () => {
            const payload = currentMode === 'text'
                ? { text: textInput.value.trim(), source: 'Text Input' }
                : { image_url: imageUrlInput.value.trim(), source: imageUrlInput.value.trim() };

            if ((currentMode === 'text' && !payload.text) || (currentMode === 'image' && !payload.image_url)) {
                alert('Please provide input to analyze.');
                return;
            }

            setLoadingState(true);
            resultsContainer.innerHTML = createLoadingSpinner();
            resultsContainer.classList.remove('hidden');

            try {
                const response = await fetch(`${BASE_URL}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) throw new Error((await response.json()).detail);

                const data = await response.json();
                resultsContainer.innerHTML = createResultCard(data, true);
                updateScoreCircle(data.score, data.id);
                await loadRecentAnalyses();
            } catch (error) {
                resultsContainer.innerHTML = `<p class="text-red-400 text-center">Analysis failed: ${error.message}</p>`;
            } finally {
                setLoadingState(false);
            }
        });

        // --- Feed & Dashboard ---
        async function loadRecentAnalyses() {
            try {
                const response = await fetch(`${BASE_URL}/recent`);
                if (!response.ok) throw new Error('Failed to fetch recent analyses.');
                const analyses = await response.json();
                feedList.innerHTML = analyses.length ? '' : `<p class="text-gray-500 text-center">No analyses yet.</p>`;
                analyses.forEach(analysis => {
                    const card = document.createElement('div');
                    card.innerHTML = createResultCard(analysis, false);
                    feedList.appendChild(card);
                    updateScoreCircle(analysis.score, analysis.id);
                });
            } catch (error) {
                feedList.innerHTML = `<p class="text-red-400 text-center">Could not load feed.</p>`;
            }
        }

        async function loadDashboardData() {
            try {
                const response = await fetch(`${BASE_URL}/stats`);
                if (!response.ok) throw new Error('Failed to fetch stats.');
                const stats = await response.json();
                drawHeatmap(stats.hot_topics);
                drawGraph(stats.propagation_graph);
            } catch (error) {
                heatmapContainer.innerHTML = `<p class="text-red-400 text-center p-4">Could not load dashboard data.</p>`;
                graphContainer.innerHTML = ``;
            }
        }

        // --- Counter-Narrative ---
        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('generate-counter-btn')) {
                const button = e.target;
                const claims = JSON.parse(button.dataset.claims);
                const container = document.getElementById(`counter-container-${button.dataset.id}`);
                button.disabled = true;
                button.textContent = 'Generating...';
                container.innerHTML = createLoadingSpinner();
                try {
                    const response = await fetch(`${BASE_URL}/generate_counter`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ claims }),
                    });
                    if (!response.ok) throw new Error('Failed to generate.');
                    const data = await response.json();
                    container.innerHTML = `<p class="text-gray-300 bg-gray-900 p-3 rounded-md">${data.narrative}</p><button class="copy-btn mt-2 text-sm bg-gray-600 hover:bg-gray-500 px-3 py-1 rounded-md" data-text="${data.narrative}">Copy Text</button>`;
                } catch (error) {
                    container.innerHTML = `<p class="text-red-400">Failed to generate.</p>`;
                } finally {
                    button.style.display = 'none';
                }
            }
            if (e.target.classList.contains('copy-btn')) {
                navigator.clipboard.writeText(e.target.dataset.text).then(() => {
                    e.target.textContent = 'Copied!';
                    setTimeout(() => e.target.textContent = 'Copy Text', 2000);
                });
            }
        });

        // --- UI Generation ---
        function createResultCard(data, isMainResult) {
            const claimsHTML = data.claims && data.claims.length > 0 ? `<div class="mt-6 border-t border-gray-700 pt-4"><h4 class="text-lg font-semibold mb-2">Key Claims Identified:</h4><ul class="list-disc list-inside space-y-2 text-gray-400">${data.claims.map(c => `<li><strong class="${c.status === 'Supported' ? 'text-green-400' : c.status === 'Refuted' ? 'text-red-400' : 'text-yellow-400'}">[${c.status}]</strong> ${c.claim}</li>`).join('')}</ul></div>` : '';
            const sourceText = data.source.startsWith('http') ? `<a href="${data.source}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline break-all">${data.source}</a>` : `<span class="italic">"${data.source.substring(0, 100)}${data.source.length > 100 ? '...' : ''}"</span>`;
            const counterSection = data.score < 50 ? `<div class="mt-6 border-t border-gray-700 pt-4"><h4 class="text-lg font-semibold mb-2 text-amber-400">Take Action</h4><p class="text-sm text-gray-400 mb-3">This content has a low credibility score. Generate a fact-based response to counter it.</p><button class="generate-counter-btn bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-md text-sm" data-id="${data.id}" data-claims='${JSON.stringify(data.claims)}'>Generate Counter-Narrative</button><div id="counter-container-${data.id}" class="mt-3"></div></div>` : '';
            const coachSection = data.coach_feedback ? `<div class="mt-6 border-t border-gray-700 pt-4"><h4 class="text-lg font-semibold mb-2 text-sky-400">🤖 AI Coach Feedback</h4><p class="text-gray-300 bg-gray-900 p-3 rounded-md">${data.coach_feedback}</p></div>` : '';

            return `<div class="bg-gray-800 border border-gray-700 rounded-lg p-6 shadow-xl">${isMainResult ? '<h2 class="text-2xl font-bold text-center mb-6">Analysis Result</h2>' : ''}<p class="text-sm text-gray-500 mb-4">Source: ${sourceText}</p><div class="flex flex-col md:flex-row items-center justify-center gap-8"><div class="relative w-40 h-40 flex-shrink-0"><svg class="transform -rotate-90" width="100%" height="100%" viewBox="0 0 120 120"><circle cx="60" cy="60" r="50" stroke-width="10" stroke="#4A5568" fill="none" /><circle id="score-circle-${data.id}" class="score-ring" cx="60" cy="60" r="50" stroke-width="10" stroke="url(#scoreGradient)" fill="none" stroke-linecap="round" /><defs><linearGradient id="scoreGradient" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#EF4444;" /><stop offset="50%" style="stop-color:#F59E0B;" /><stop offset="100%" style="stop-color:#10B981;" /></linearGradient></defs></svg><div id="score-text-${data.id}" class="absolute inset-0 flex items-center justify-center text-4xl font-bold">${data.score}</div></div><div class="flex-1 text-center md:text-left"><h3 class="text-xl font-semibold mb-2">Credibility Score</h3><p class="text-gray-300">${data.summary}</p></div></div>${coachSection}${claimsHTML}${counterSection}</div>`;
        }
        function createLoadingSpinner() { return `<div class="flex justify-center items-center p-4"><svg class="animate-spin h-8 w-8 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>`; }
        function setLoadingState(isLoading) {
            analyzeButton.disabled = isLoading;
            buttonText.textContent = isLoading ? 'Analyzing...' : 'Analyze';
            buttonIcon.innerHTML = isLoading ? `<svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>` : `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>`;
        }
        function updateScoreCircle(score, id) {
            setTimeout(() => {
                const circle = document.getElementById(`score-circle-${id}`);
                if (circle) {
                    const offset = 314 - (score / 100) * 314;
                    circle.style.strokeDashoffset = offset;
                }
            }, 100);
        }

        // --- D3 Visualizations ---
        function drawHeatmap(data) {
            heatmapContainer.innerHTML = '';
            const margin = {top: 20, right: 30, bottom: 40, left: 120},
                  width = heatmapContainer.clientWidth - margin.left - margin.right,
                  height = heatmapContainer.clientHeight - margin.top - margin.bottom;

            const svg = d3.select("#heatmap-container").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const y = d3.scaleBand().range([0, height]).domain(data.map(d => d.topic)).padding(0.1);
            svg.append("g").call(d3.axisLeft(y)).selectAll("text").style("fill", "white");

            const x = d3.scaleLinear().domain([0, d3.max(data, d => d.count)]).range([0, width]);
            svg.append("g").call(d3.axisBottom(x)).attr("transform", `translate(0,${height})`).selectAll("text").style("fill", "white");

            const color = d3.scaleSequential(d3.interpolateReds).domain([0, d3.max(data, d => d.count)]);

            svg.selectAll().data(data).enter().append("rect")
                .attr("y", d => y(d.topic))
                .attr("x", x(0))
                .attr("width", d => x(d.count))
                .attr("height", y.bandwidth())
                .style("fill", d => color(d.count));
        }

        function drawGraph(data) {
            graphContainer.innerHTML = '';
            const width = graphContainer.clientWidth;
            const height = graphContainer.clientHeight;
            const svg = d3.select("#graph-container").append("svg").attr("width", width).attr("height", height);
            const tooltip = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);

            const simulation = d3.forceSimulation(data.nodes)
                .force("link", d3.forceLink(data.links).id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-200))
                .force("center", d3.forceCenter(width / 2, height / 2));

            const link = svg.append("g").attr("class", "links").selectAll("line").data(data.links).enter().append("line").attr("class", "link");
            const node = svg.append("g").attr("class", "nodes").selectAll("circle").data(data.nodes).enter().append("circle").attr("class", "node")
                .attr("r", d => d.type === 'source' ? 10 : 5)
                .attr("fill", d => d.type === 'source' ? "#F59E0B" : "#EF4444")
                .call(d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended))
                .on("mouseover", (event, d) => {
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html(`<b>${d.id}</b><br>${d.type === 'source' ? 'Source' : 'Claim'}`)
                        .style("left", (event.pageX + 5) + "px").style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0));

            simulation.on("tick", () => {
                link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
                node.attr("cx", d => d.x).attr("cy", d => d.y);
            });

            function dragstarted(event, d) { if (!event.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
            function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
            function dragended(event, d) { if (!event.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', loadRecentAnalyses);

    </script>
</body>
</html>

